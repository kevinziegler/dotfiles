config:
  dotpath: ~/.dotfiles
  link_dotfile_default: relative
  import_variables:
    - "uservariables.yaml:optional"

profiles:
  system:
    dotfiles:
      - brewfile
      - tool_versions
      - dotfiles_remote

  applications:
    dotfiles:
      - onepassword
      - finickyjs

  identity:
    dotfiles:
      - ssh_config
      - gpg_identity

  git:
    dotfiles:
      - gitconfig
      - gitignore_global
      - gitconfig_local
      - git_attributes
      - hub

  zsh:
    dotfiles:
      - zshrc
      - zshenv
      - zsh_plugins

  emacs:
    dotfiles:
      - doom_emacs
      - doom_emacs_local

  misc:
    dotfiles:
      - myclirc
      - pgcli_config
      - psqlrc
      - mackup_cfg

  test:
    dotfiles:
      - finickyjs
    dynvariables:
      op_session: "echo FOOBAR"

dotfiles:
  brewfile:
    src: system/Brewfile
    dst: ~/.Brewfile
    actions:
      - install_homebrew
      - brew_bundle

  doom_emacs:
    src:
    dst:
    actions:
      - setup_emacs

  doom_emacs_local:
    src: tools/doom-local.tmpl.el
    dst: ~/.doom.d/conf.d/local.el
    link: nolink

  dotfiles_remote:
    src:
    dst:
    actions:
      - dotfiles_set_ssh_url

  finickyjs:
    src: tools/finicky.js
    dst: ~/.finicky.js
    actions:
      - set_default_browser

  gitconfig:
    src: tools/git/gitconfig
    dst: ~/.gitconfig

  gitconfig_local:
    src: tools/git/gitconfig.local.tmpl
    dst: ~/.gitconfig.local
    link: nolink

  gitignore_global:
    src: tools/git/gitignore_global
    dst: ~/.gitignore_global

  git_attributes:
    src: tools/git/attributes
    dst: ~/.config/git/attributes

  # TODO Test me!
  gpg_identity:
    src:
    dst:
    actions:
      - import_gpg_key

  hub:
    src: tools/hub.tmpl.yaml
    dst: ~/.config/hub
    template: false
    link: nolink
    trans_read: op_inject

  mackup_cfg:
    src: system/mackup.cfg
    dst: ~/.mackup.cfg

  myclirc:
    src: tools/myclirc
    dst: ~/.myclirc

  onepassword:
    src:
    dst:
    actions:
      - init_1password_app
      - init_1password_cli

  pgcli_config:
    src: tools/pgcli.toml
    dst: ~/.config/pgcli/config

  psqlrc:
    src: tools/psqlrc
    dst: ~/.psqlrc

  ssh_config:
    src: tools/ssh_config
    dst: ~/.ssh/config

  tool_versions:
    src: "{{@@ tool_versions_src @@}}"
    dst: ~/.tool-versions
    link: nolink
    trans_read: asdf_config_latest
    actions:
      - asdf_install

  zshenv:
    src: tools/zsh/zshenv.zsh
    dst: ~/.zshenv

  zshrc:
    src: tools/zsh/zshrc.zsh
    dst: ~/.zshrc

  zsh_plugins:
    src: tools/zsh/plugins.txt
    dst: ~/.plugins.zsh
    link: nolink
    trans_read: antibody_bundle

uservariables:
  system_email: "System email (e.g. your work email)"

# TODO Make this work with "bootstrap" profiles?
dynvariables:
  op_session: "op signin --account {{@@ op_alias @@}} --raw"

variables:
  scripts: "{{@@ _dotdrop_dotpath @@}}/scripts"
  op_alias: "personal"
  op_setup_file: "/Volumes/BOOTSTRAP/onepassword-setup.txt"
  op_gpg_item: "Personal GPG Identity"
  tool_versions_src: "system/tool-versions"

trans_read:
  asdf_config_latest: "<{0} xargs -L1 {{@@ scripts @@}}/asdf-entry-latest >> {1}"
  op_inject: "op inject --session {{@@ op_session @@}} --in-file {0} --out-file {1}"
  antibody_bundle: "antibody bundle < {0} > {1}"

actions:
  pre:
    asdf_init_plugins: "asdf plugin update --all && <{{@@ dotdrop_dotpath @@}}/{{@@ tool_versions_src @@}} xargs -L1 asdf plugin add"
    install_homebrew: "{{@@ scripts @@}}/install-homebrew"
  post:
    asdf_install: "asdf install"
    brew_bundle: "brew bundle --global"
    mackup_restore: "mackup restore"
    setup_emacs: "{{@@ scripts @@}}/setup-emacs"
    set_default_browser: "defaultbrowser finicky"
    dotfiles_set_ssh_url: "{{@@ scripts @@}}/set-git-ssh-remote {{@@ _dotdrop_dotpath @@}} origin"
    init_1password_app: "{{@@ scripts @@}}/init-1password-app {{@@ op_setup_file @@}}"
    init_1password_cli: "{{@@ scripts @@}}/init-1password-cli {{@@ op_alias @@}} {{@@ op_setup_file @@}}"
    import_gpg_key: "{{@@ scripts @@}}/import-gpg-key"
