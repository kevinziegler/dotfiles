# This file covers "stage 0" setup steps, where we're starting with a "clean"
# system.  This allows us to stage building blocks (such as 1Password) to
# faciliate other steps later in the process (such as injecting secrets).
#
# This is meant to run as a seprate process to avoid dependency issues in how
# dotdrop processes dynamic variables.
config:
  dotpath: ~/.dotfiles
  link_dotfile_default: relative
  import_variables:
    - 'uservariables.yaml:optional'

profiles:
  bootstrap:
    dotfiles:
      - brewfile
      - tool_versions
      - dotfiles_dir
      - manual_setup

uservariables:
  personal_email: "Personal Email"
  onepassword_address: "1Password Address (e.g. foo.1password.com)"
  system_email: "System Email"
  system_comment: "System Comment (e.g. Work Laptop)"

variables:
  brew_url: "https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh"
  brew_install_script: "/tmp/brew-installer.sh"

trans_read:
  asdf_set_latest: "<{0} xargs -L1 -I@ bash -c 'echo -n \"@ \" && asdf latest @' > {1}"

dotfiles:
  tool_versions:
    src: system/tool-versions
    dst: ~/.tool-versions
    link: nolink
    trans_read: asdf_set_latest
    actions:
      - asdf_add_plugins
      - asdf_install

  brewfile:
    src: system/Brewfile
    dst: ~/.Brewfile
    actions:
      # - install_homebrew
      - brew_bundle

  dotfiles_dir:
    src:
    dst:
    actions:
      - set_dotfiles_ssh_remote

  manual_setup:
    src:
    dst:
    actions:
      - init_manual

actions:
  pre:
    install_homebrew: /bin/bash -C "`curl -fsSl {{@@ brew_url @@}}`"
  post:
    asdf_add_plugins: <{0} xargs -L1 asdf plugin add
    asdf_install: asdf install
    brew_bundle: brew bundle --global
